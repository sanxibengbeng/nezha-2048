<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²’å­æ•ˆæœç³»ç»Ÿæµ‹è¯• - å“ªå’2048</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .test-controls {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            text-align: center;
            position: relative;
            z-index: 1000;
        }
        
        .test-btn {
            margin: 5px;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .test-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .test-section h4 {
            margin: 0 0 15px 0;
            color: #DC143C;
            text-align: center;
        }
        
        .canvas-container {
            position: relative;
            margin: 20px auto;
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        #particle-canvas {
            display: block;
            cursor: crosshair;
        }
        
        .quality-control {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .quality-control select {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin: 0 10px;
        }
        
        .status-display {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 255, 0.3);
            text-align: left;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .instruction-box {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .instruction-box h4 {
            margin: 0 0 10px 0;
            color: #DC143C;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .nezha-effects {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
        }
        
        .game-effects {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
        }
        
        .environment-effects {
            background: rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }
    </style>
</head>
<body data-theme="nezha">
    <div id="game-container">
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="test-controls">
            <h3>ç²’å­æ•ˆæœç³»ç»Ÿæµ‹è¯•</h3>
            <div class="instruction-box">
                <h4>ğŸ† ç²’å­æ•ˆæœç³»ç»Ÿæµ‹è¯•è¯´æ˜ï¼š</h4>
                <p>1. ç‚¹å‡»"å¯åŠ¨ç²’å­ç³»ç»Ÿ"å¼€å§‹æµ‹è¯•</p>
                <p>2. åœ¨ç”»å¸ƒä¸Šç‚¹å‡»åˆ›å»ºå„ç§ç²’å­æ•ˆæœ</p>
                <p>3. æµ‹è¯•åŸºç¡€ç²’å­é¢„è®¾å’Œå“ªå’ä¸»é¢˜ç‰¹æ•ˆ</p>
                <p>4. è°ƒæ•´è´¨é‡ç­‰çº§è§‚å¯Ÿæ€§èƒ½å·®å¼‚</p>
                <p>5. è§‚å¯Ÿç²’å­ç³»ç»ŸçŠ¶æ€ä¿¡æ¯</p>
            </div>
            
            <!-- ç³»ç»Ÿæ§åˆ¶ -->
            <div class="test-section">
                <h4>ğŸ›ï¸ ç³»ç»Ÿæ§åˆ¶</h4>
                <button class="test-btn" onclick="startParticleSystem()">å¯åŠ¨ç²’å­ç³»ç»Ÿ</button>
                <button class="test-btn" onclick="stopParticleSystem()">åœæ­¢ç²’å­ç³»ç»Ÿ</button>
                <button class="test-btn" onclick="clearAllEffects()">æ¸…é™¤æ‰€æœ‰ç‰¹æ•ˆ</button>
                <button class="test-btn" onclick="showSystemStatus()">æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€</button>
            </div>
            
            <!-- è´¨é‡æ§åˆ¶ -->
            <div class="quality-control">
                <h4>âš™ï¸ è´¨é‡æ§åˆ¶</h4>
                <label>ç‰¹æ•ˆè´¨é‡:</label>
                <select id="quality-select" onchange="changeQuality()">
                    <option value="high">é«˜è´¨é‡</option>
                    <option value="medium">ä¸­ç­‰è´¨é‡</option>
                    <option value="low">ä½è´¨é‡</option>
                </select>
                <button class="test-btn" onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
            </div>
            
            <!-- åŸºç¡€ç²’å­é¢„è®¾ -->
            <div class="test-section">
                <h4>ğŸ”¥ åŸºç¡€ç²’å­é¢„è®¾</h4>
                <div class="preset-grid">
                    <button class="test-btn" onclick="setCurrentEffect('fire')">ç«ç„°</button>
                    <button class="test-btn" onclick="setCurrentEffect('spark')">ç«èŠ±</button>
                    <button class="test-btn" onclick="setCurrentEffect('glow')">å…‰èŠ’</button>
                    <button class="test-btn" onclick="setCurrentEffect('smoke')">çƒŸé›¾</button>
                    <button class="test-btn" onclick="setCurrentEffect('explosion')">çˆ†ç‚¸</button>
                    <button class="test-btn" onclick="setCurrentEffect('magic')">é­”æ³•</button>
                    <button class="test-btn" onclick="setCurrentEffect('lotus')">è²èŠ±</button>
                    <button class="test-btn" onclick="setCurrentEffect('divine')">ç¥åœ£</button>
                </div>
            </div>
            
            <!-- å“ªå’ä¸»é¢˜ç‰¹æ•ˆ -->
            <div class="test-section nezha-effects">
                <h4>âš¡ å“ªå’ä¸»é¢˜ç‰¹æ•ˆ</h4>
                <div class="preset-grid">
                    <button class="test-btn" onclick="setCurrentEffect('threeHeadsActivation')">ä¸‰å¤´å…­è‡‚</button>
                    <button class="test-btn" onclick="setCurrentEffect('qiankunCircleCharge')">ä¹¾å¤åœˆ</button>
                    <button class="test-btn" onclick="setCurrentEffect('huntianLingFlow')">æ··å¤©ç»«</button>
                    <button class="test-btn" onclick="setCurrentEffect('transformationAura')">å“ªå’å˜èº«</button>
                </div>
            </div>
            
            <!-- æ¸¸æˆç‰¹æ•ˆ -->
            <div class="test-section game-effects">
                <h4>ğŸ® æ¸¸æˆç‰¹æ•ˆ</h4>
                <div class="preset-grid">
                    <button class="test-btn" onclick="setCurrentEffect('tileSpawn')">æ–¹å—ç”Ÿæˆ</button>
                    <button class="test-btn" onclick="setCurrentEffect('tileMerge')">æ–¹å—åˆå¹¶</button>
                    <button class="test-btn" onclick="setCurrentEffect('scoreBonus')">åˆ†æ•°å¥–åŠ±</button>
                    <button class="test-btn" onclick="setCurrentEffect('comboEffect')">è¿å‡»ç‰¹æ•ˆ</button>
                </div>
            </div>
            
            <!-- ç¯å¢ƒç‰¹æ•ˆ -->
            <div class="test-section environment-effects">
                <h4>ğŸŒŸ ç¯å¢ƒç‰¹æ•ˆ</h4>
                <div class="preset-grid">
                    <button class="test-btn" onclick="setCurrentEffect('backgroundAmbient')">èƒŒæ™¯ç¯å¢ƒ</button>
                    <button class="test-btn" onclick="setCurrentEffect('victoryBurst')">èƒœåˆ©çˆ†å‘</button>
                    <button class="test-btn" onclick="setCurrentEffect('gameOverFade')">æ¸¸æˆç»“æŸ</button>
                </div>
            </div>
            
            <!-- ç‰¹æ®Šæµ‹è¯• -->
            <div class="test-section">
                <h4>ğŸ­ ç‰¹æ®Šæµ‹è¯•</h4>
                <button class="test-btn" onclick="testMultipleEffects()">å¤šé‡ç‰¹æ•ˆ</button>
                <button class="test-btn" onclick="testEffectSequence()">ç‰¹æ•ˆåºåˆ—</button>
                <button class="test-btn" onclick="testRandomEffects()">éšæœºç‰¹æ•ˆ</button>
                <button class="test-btn" onclick="testContinuousEffects()">è¿ç»­ç‰¹æ•ˆ</button>
            </div>
            
            <!-- ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º -->
            <div class="status-display" id="status-display" style="display: none;">
                <h4>ğŸ“Š ç³»ç»ŸçŠ¶æ€ï¼š</h4>
                <div id="status-content"></div>
            </div>
            
            <div style="margin-top: 15px;">
                <p><strong>å½“å‰ç‰¹æ•ˆ:</strong> <span id="current-effect">æ— </span></p>
                <p><strong>æç¤º:</strong> åœ¨ç”»å¸ƒä¸Šç‚¹å‡»åˆ›å»ºç‰¹æ•ˆ</p>
            </div>
        </div>

        <!-- ç²’å­ç”»å¸ƒ -->
        <div class="canvas-container">
            <canvas id="particle-canvas" width="800" height="600"></canvas>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="js/effects/ParticleSystem.js"></script>
    <script src="js/managers/EffectsManager.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let particleSystem = null;
        let effectsManager = null;
        let canvas = null;
        let animationId = null;
        let currentEffect = 'fire';
        let isRunning = false;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('particle-canvas');
            
            // ç»‘å®šç”»å¸ƒç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', (event) => {
                if (!isRunning) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                createEffectAtPosition(x, y);
            });
            
            console.log('ç²’å­æ•ˆæœç³»ç»Ÿæµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        function startParticleSystem() {
            try {
                // åˆ›å»ºç²’å­ç³»ç»Ÿ
                particleSystem = new ParticleSystem(canvas);
                effectsManager = new EffectsManager(canvas);
                
                // å¯åŠ¨ç³»ç»Ÿ
                particleSystem.start();
                effectsManager.start();
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                startRenderLoop();
                
                isRunning = true;
                console.log('âœ… ç²’å­ç³»ç»Ÿå·²å¯åŠ¨');
                
            } catch (error) {
                console.error('âŒ å¯åŠ¨ç²’å­ç³»ç»Ÿå¤±è´¥:', error);
            }
        }

        function stopParticleSystem() {
            if (particleSystem) {
                particleSystem.stop();
            }
            if (effectsManager) {
                effectsManager.stop();
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            isRunning = false;
            console.log('â¹ï¸ ç²’å­ç³»ç»Ÿå·²åœæ­¢');
        }

        function startRenderLoop() {
            function render(currentTime) {
                if (!isRunning) return;
                
                // æ¸…é™¤ç”»å¸ƒ
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // æ›´æ–°å’Œæ¸²æŸ“
                if (particleSystem) {
                    particleSystem.update(currentTime);
                    particleSystem.render();
                }
                
                if (effectsManager) {
                    effectsManager.update(currentTime);
                    effectsManager.render();
                }
                
                // ç»§ç»­å¾ªç¯
                animationId = requestAnimationFrame(render);
            }
            
            animationId = requestAnimationFrame(render);
        }

        function setCurrentEffect(effectName) {
            currentEffect = effectName;
            document.getElementById('current-effect').textContent = effectName;
            console.log(`å½“å‰ç‰¹æ•ˆè®¾ç½®ä¸º: ${effectName}`);
        }

        function createEffectAtPosition(x, y) {
            if (!isRunning) return;
            
            try {
                if (effectsManager && effectsManager.nezhaEffects[currentEffect]) {
                    // ä½¿ç”¨ç‰¹æ•ˆç®¡ç†å™¨åˆ›å»ºå“ªå’ä¸»é¢˜ç‰¹æ•ˆ
                    effectsManager.createNezhaEffect(currentEffect, x, y);
                } else if (particleSystem) {
                    // ä½¿ç”¨ç²’å­ç³»ç»Ÿåˆ›å»ºåŸºç¡€ç‰¹æ•ˆ
                    particleSystem.createEffect(currentEffect, x, y);
                }
                
                console.log(`åœ¨ (${x}, ${y}) åˆ›å»ºç‰¹æ•ˆ: ${currentEffect}`);
                
            } catch (error) {
                console.error('åˆ›å»ºç‰¹æ•ˆå¤±è´¥:', error);
            }
        }

        function clearAllEffects() {
            if (particleSystem) {
                particleSystem.clear();
            }
            if (effectsManager) {
                effectsManager.clear();
            }
            console.log('ğŸ—‘ï¸ æ‰€æœ‰ç‰¹æ•ˆå·²æ¸…é™¤');
        }

        function changeQuality() {
            const quality = document.getElementById('quality-select').value;
            if (effectsManager) {
                effectsManager.setQualityLevel(quality);
                console.log(`ç‰¹æ•ˆè´¨é‡è®¾ç½®ä¸º: ${quality}`);
            }
        }

        function showSystemStatus() {
            if (!particleSystem || !effectsManager) {
                console.log('ç³»ç»Ÿæœªå¯åŠ¨');
                return;
            }
            
            const particleStatus = particleSystem.getStatus();
            const effectsStatus = effectsManager.getStatus();
            
            const statusDiv = document.getElementById('status-display');
            const contentDiv = document.getElementById('status-content');
            
            contentDiv.innerHTML = `
                <div><strong>ç²’å­ç³»ç»ŸçŠ¶æ€:</strong></div>
                <div>  è¿è¡ŒçŠ¶æ€: ${particleStatus.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</div>
                <div>  æ´»è·ƒç²’å­: ${particleStatus.particleCount}</div>
                <div>  å‘å°„å™¨æ•°é‡: ${particleStatus.emitterCount}</div>
                <div>  ç²’å­æ± å¤§å°: ${particleStatus.poolSize}</div>
                <div>  æœ€å¤§ç²’å­æ•°: ${particleStatus.maxParticles}</div>
                <br>
                <div><strong>ç‰¹æ•ˆç®¡ç†å™¨çŠ¶æ€:</strong></div>
                <div>  æ´»è·ƒç‰¹æ•ˆ: ${effectsStatus.activeEffects}</div>
                <div>  é˜Ÿåˆ—ç‰¹æ•ˆ: ${effectsStatus.queuedEffects}</div>
                <div>  è´¨é‡ç­‰çº§: ${effectsStatus.qualityLevel}</div>
                <div>  æœ€å¤§ç‰¹æ•ˆæ•°: ${effectsStatus.maxEffects}</div>
            `;
            
            statusDiv.style.display = 'block';
            console.log('ğŸ“Š ç³»ç»ŸçŠ¶æ€å·²æ˜¾ç¤º');
        }

        function testPerformance() {
            if (!isRunning) {
                console.log('è¯·å…ˆå¯åŠ¨ç²’å­ç³»ç»Ÿ');
                return;
            }
            
            console.log('ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            
            // åˆ›å»ºå¤§é‡ç‰¹æ•ˆè¿›è¡Œæ€§èƒ½æµ‹è¯•
            const testCount = 20;
            const effects = ['fire', 'spark', 'explosion', 'magic'];
            
            for (let i = 0; i < testCount; i++) {
                setTimeout(() => {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const effect = effects[Math.floor(Math.random() * effects.length)];
                    
                    if (particleSystem) {
                        particleSystem.createEffect(effect, x, y);
                    }
                }, i * 100);
            }
            
            // 5ç§’åæ˜¾ç¤ºæ€§èƒ½ç»“æœ
            setTimeout(() => {
                showSystemStatus();
                console.log('æ€§èƒ½æµ‹è¯•å®Œæˆ');
            }, 5000);
        }

        function testMultipleEffects() {
            if (!isRunning) return;
            
            console.log('ğŸ† æµ‹è¯•å¤šé‡ç‰¹æ•ˆ...');
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 100;
            
            const effects = ['fire', 'spark', 'glow', 'magic'];
            
            effects.forEach((effect, index) => {
                const angle = (index / effects.length) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                setTimeout(() => {
                    if (particleSystem) {
                        particleSystem.createEffect(effect, x, y);
                    }
                }, index * 200);
            });
        }

        function testEffectSequence() {
            if (!isRunning) return;
            
            console.log('ğŸ­ æµ‹è¯•ç‰¹æ•ˆåºåˆ—...');
            
            const sequence = [
                { effect: 'spark', delay: 0 },
                { effect: 'fire', delay: 500 },
                { effect: 'explosion', delay: 1000 },
                { effect: 'smoke', delay: 1500 },
                { effect: 'glow', delay: 2000 }
            ];
            
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            
            sequence.forEach(step => {
                setTimeout(() => {
                    if (particleSystem) {
                        particleSystem.createEffect(step.effect, x, y);
                    }
                }, step.delay);
            });
        }

        function testRandomEffects() {
            if (!isRunning) return;
            
            console.log('ğŸ² æµ‹è¯•éšæœºç‰¹æ•ˆ...');
            
            const effects = ['fire', 'spark', 'glow', 'smoke', 'explosion', 'magic', 'lotus', 'divine'];
            const count = 15;
            
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const effect = effects[Math.floor(Math.random() * effects.length)];
                    
                    if (particleSystem) {
                        particleSystem.createEffect(effect, x, y);
                    }
                }, i * 300);
            }
        }

        function testContinuousEffects() {
            if (!isRunning) return;
            
            console.log('ğŸ”„ æµ‹è¯•è¿ç»­ç‰¹æ•ˆ...');
            
            let count = 0;
            const maxCount = 30;
            
            const interval = setInterval(() => {
                if (count >= maxCount || !isRunning) {
                    clearInterval(interval);
                    return;
                }
                
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const effects = ['spark', 'glow'];
                const effect = effects[Math.floor(Math.random() * effects.length)];
                
                if (particleSystem) {
                    particleSystem.createEffect(effect, x, y);
                }
                
                count++;
            }, 200);
        }
    </script>
</body>
</html>