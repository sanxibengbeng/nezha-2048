<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆç»“æŸåŠŸèƒ½æµ‹è¯• - å“ªå’2048</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .test-controls {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            text-align: center;
        }
        
        .test-btn {
            margin: 5px;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .test-info {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 0, 0.1);
            border-radius: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body data-theme="nezha">
    <div id="game-container">
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="test-controls">
            <h3>æ¸¸æˆç»“æŸåŠŸèƒ½æµ‹è¯•</h3>
            <div class="test-info">
                <p>æµ‹è¯•æ¸¸æˆç»“æŸæ£€æµ‹ã€æ¨¡æ€æ¡†æ˜¾ç¤ºå’Œé‡æ–°å¼€å§‹åŠŸèƒ½</p>
            </div>
            <button class="test-btn" onclick="testGameOver()">æ¨¡æ‹Ÿæ¸¸æˆç»“æŸ</button>
            <button class="test-btn" onclick="testNewRecord()">æ¨¡æ‹Ÿæ–°çºªå½•</button>
            <button class="test-btn" onclick="testRestartConfirm()">æµ‹è¯•é‡æ–°å¼€å§‹ç¡®è®¤</button>
            <button class="test-btn" onclick="fillGrid()">å¡«æ»¡ç½‘æ ¼</button>
            <button class="test-btn" onclick="clearTestResults()">æ¸…é™¤æµ‹è¯•ç»“æœ</button>
            <div id="test-results" style="margin-top: 10px; font-size: 0.9rem;"></div>
        </div>

        <!-- æ¸¸æˆæ ‡é¢˜å’ŒUI -->
        <header class="game-header">
            <h1 class="game-title">å“ªå’2048</h1>
            <div class="score-container">
                <div class="score-box">
                    <div class="score-label">åˆ†æ•°</div>
                    <div id="current-score" class="score-value">0</div>
                </div>
                <div class="score-box">
                    <div class="score-label">æœ€é«˜åˆ†</div>
                    <div id="high-score" class="score-value">0</div>
                </div>
            </div>
        </header>

        <!-- æ¸¸æˆä¿¡æ¯æ˜¾ç¤º -->
        <div class="game-info">
            <div class="info-item">
                <span class="info-label">ç§»åŠ¨:</span>
                <span id="moves-count" class="info-value">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ—¶é—´:</span>
                <span id="play-time" class="info-value">0:00</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç­‰çº§:</span>
                <span id="nezha-level" class="info-value">1</span>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
        <div class="game-area">
            <canvas id="game-canvas" width="400" height="400"></canvas>
            <div id="game-grid" class="game-grid breathing">
                <!-- 4x4ç½‘æ ¼å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <!-- ç‰¹æ•ˆå®¹å™¨ -->
            <div id="effects-container" class="effects-container"></div>
        </div>

        <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
        <div class="game-controls">
            <button id="new-game-btn" class="control-btn primary">æ–°æ¸¸æˆ</button>
            <button id="pause-btn" class="control-btn">æš‚åœ</button>
            <button id="settings-btn" class="control-btn">è®¾ç½®</button>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>æœ€ç»ˆåˆ†æ•°: <span id="final-score">0</span></p>
            <p id="new-record" class="hidden">ğŸ‰ æ–°çºªå½•ï¼</p>
            <div class="modal-buttons">
                <button id="restart-btn" class="control-btn primary">é‡æ–°å¼€å§‹</button>
                <button id="close-modal-btn" class="control-btn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <h2>æ¸¸æˆè®¾ç½®</h2>
            <div class="setting-item">
                <label for="volume-slider">éŸ³é‡</label>
                <input type="range" id="volume-slider" min="0" max="100" value="70">
            </div>
            <div class="setting-item">
                <label for="theme-select">ä¸»é¢˜</label>
                <select id="theme-select">
                    <option value="nezha">å“ªå’ä¸»é¢˜</option>
                    <option value="classic">ç»å…¸ä¸»é¢˜</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button id="save-settings-btn" class="control-btn primary">ä¿å­˜</button>
                <button id="cancel-settings-btn" class="control-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="js/core/Tile.js"></script>
    <script src="js/core/GameState.js"></script>
    <script src="js/core/ThemeConfig.js"></script>
    <script src="js/managers/GridManager.js"></script>
    <script src="js/managers/InputManager.js"></script>
    <script src="js/managers/ThemeManager.js"></script>
    <script src="js/managers/AnimationSystem.js"></script>
    <script src="js/managers/AudioManager.js"></script>
    <script src="js/managers/StateManager.js"></script>
    <script src="js/systems/NezhaSkillSystem.js"></script>
    <script src="js/core/GameEngine.js"></script>
    <script src="js/main.js"></script>

    <script>
        // æµ‹è¯•å‡½æ•°
        function logTest(message) {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }

        function testGameOver() {
            if (!game) {
                logTest('âŒ æ¸¸æˆå¼•æ“æœªåˆå§‹åŒ–');
                return;
            }

            logTest('ğŸ§ª å¼€å§‹æµ‹è¯•æ¸¸æˆç»“æŸåŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿæ¸¸æˆç»“æŸçŠ¶æ€
            const gameState = game.getGameState();
            gameState.isGameOver = true;
            gameState.score = 12345;
            gameState.moves = 150;
            gameState.playTime = 300; // 5åˆ†é’Ÿ
            
            // è§¦å‘æ¸¸æˆç»“æŸäº‹ä»¶
            game.emit('gameOver', {
                score: gameState.score,
                highScore: gameState.highScore,
                moves: gameState.moves,
                playTime: gameState.playTime,
                maxTile: 512,
                isNewRecord: false,
                statistics: {
                    totalMoves: gameState.moves,
                    totalMerges: 75,
                    maxConsecutiveMerges: 5,
                    skillsUsed: { threeHeadsSixArms: 2, qiankunCircle: 1 },
                    nezhaLevel: 3,
                    playTimeFormatted: '5:00',
                    efficiency: 82
                }
            });
            
            logTest('âœ… æ¸¸æˆç»“æŸäº‹ä»¶å·²è§¦å‘');
        }

        function testNewRecord() {
            if (!game) {
                logTest('âŒ æ¸¸æˆå¼•æ“æœªåˆå§‹åŒ–');
                return;
            }

            logTest('ğŸ§ª å¼€å§‹æµ‹è¯•æ–°çºªå½•åŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿæ–°çºªå½•
            const gameState = game.getGameState();
            gameState.isGameOver = true;
            gameState.score = 50000; // é«˜åˆ†
            gameState.moves = 200;
            gameState.playTime = 600; // 10åˆ†é’Ÿ
            
            // è§¦å‘æ¸¸æˆç»“æŸäº‹ä»¶ï¼ˆæ–°çºªå½•ï¼‰
            game.emit('gameOver', {
                score: gameState.score,
                highScore: Math.max(gameState.highScore, gameState.score - 1000), // ç¡®ä¿æ˜¯æ–°çºªå½•
                moves: gameState.moves,
                playTime: gameState.playTime,
                maxTile: 2048,
                isNewRecord: true,
                statistics: {
                    totalMoves: gameState.moves,
                    totalMerges: 100,
                    maxConsecutiveMerges: 8,
                    skillsUsed: { threeHeadsSixArms: 5, qiankunCircle: 3, huntianLing: 2 },
                    nezhaLevel: 5,
                    playTimeFormatted: '10:00',
                    efficiency: 250
                }
            });
            
            logTest('âœ… æ–°çºªå½•äº‹ä»¶å·²è§¦å‘');
        }

        function testRestartConfirm() {
            if (!game) {
                logTest('âŒ æ¸¸æˆå¼•æ“æœªåˆå§‹åŒ–');
                return;
            }

            logTest('ğŸ§ª å¼€å§‹æµ‹è¯•é‡æ–°å¼€å§‹ç¡®è®¤åŠŸèƒ½...');
            
            // æ¨¡æ‹Ÿæ¸¸æˆè¿›è¡Œä¸­
            const gameState = game.getGameState();
            gameState.score = 1000;
            gameState.moves = 50;
            gameState.isGameOver = false;
            
            // æ›´æ–°æ˜¾ç¤º
            updateScoreDisplay();
            
            logTest('âœ… æ¸¸æˆçŠ¶æ€å·²è®¾ç½®ä¸ºè¿›è¡Œä¸­ï¼Œç‚¹å‡»"æ–°æ¸¸æˆ"æŒ‰é’®æµ‹è¯•ç¡®è®¤å¯¹è¯æ¡†');
        }

        function fillGrid() {
            if (!game) {
                logTest('âŒ æ¸¸æˆå¼•æ“æœªåˆå§‹åŒ–');
                return;
            }

            logTest('ğŸ§ª å¡«æ»¡ç½‘æ ¼ä»¥æµ‹è¯•æ¸¸æˆç»“æŸæ£€æµ‹...');
            
            const gameState = game.getGameState();
            const gridManager = game.getGridManager();
            
            // å¡«æ»¡ç½‘æ ¼ï¼Œä½†ä¸èƒ½ç§»åŠ¨
            const values = [2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2, 4, 8, 16, 32, 64];
            let index = 0;
            
            for (let x = 0; x < 4; x++) {
                for (let y = 0; y < 4; y++) {
                    const tile = new Tile(x, y, values[index % values.length]);
                    gameState.setTile(x, y, tile);
                    index++;
                }
            }
            
            // å¼ºåˆ¶æ£€æŸ¥æ¸¸æˆç»“æŸ
            setTimeout(() => {
                game.checkGameOver();
            }, 100);
            
            logTest('âœ… ç½‘æ ¼å·²å¡«æ»¡ï¼Œæ¸¸æˆç»“æŸæ£€æµ‹å·²è§¦å‘');
        }

        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
            logTest('ğŸ§¹ æµ‹è¯•ç»“æœå·²æ¸…é™¤');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ æµ‹è¯•ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                logTest('ğŸ“‹ æ¸¸æˆç»“æŸåŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
                logTest('ğŸ’¡ ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®æµ‹è¯•å„ç§æ¸¸æˆç»“æŸåœºæ™¯');
            }, 1000);
        });
    </script>
</body>
</html>